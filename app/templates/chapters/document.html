{% extends "base.html" %}

{% block title %}{{ document.title }}{% endblock %}

{% block styles %}
<style>
    /* Existing styles remain the same */
    .document-meta {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        margin-bottom: 1.5rem;
    }
    
    .document-preview {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        height: 80vh; /* Increased from 60vh to 80vh */
        overflow-y: auto;
        background-color: white;
    }
    
    /* Add scrollable notes section */
    #existingNotes {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    /* Added styles for scroll behavior */
    #existingNotes::-webkit-scrollbar {
        width: 6px;
    }
    
    #existingNotes::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    #existingNotes::-webkit-scrollbar-thumb {
        background: #dc3545;
        border-radius: 10px;
    }
    
    #existingNotes::-webkit-scrollbar-thumb:hover {
        background: #b30000;
    }
    
    /* All existing styles remain the same... */
    .summary-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #ffc107;
    }
    
    .document-actions {
        position: sticky;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 1rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top: 1px solid #dee2e6;
    }
    
    .file-type-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }
    
    .pdf-badge { background-color: #FF5722; color: white; }
    .doc-badge { background-color: #2196F3; color: white; }
    .ppt-badge { background-color: #FF9800; color: white; }
    
    /* PDF Viewer Specific Styles */
    #pdf-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    #pdf-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #f1f1f1;
        border-bottom: 1px solid #ddd;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    #pdf-viewer {
        flex: 1;
        overflow: auto;
        padding: 20px;
        background-color: #525659;
    }
    
    #pdf-pages-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 auto;
    }
    
    .pdf-page-container {
        margin-bottom: 20px;
        position: relative;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .pdf-page-canvas {
        display: block;
    }
    
    /* Text Layer Styles */
    .textLayer {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0.25;
        line-height: 1.0;
    }
    
    .textLayer > span {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        transform-origin: 0% 0%;
    }
    
    .textLayer .highlight {
        margin: -1px;
        padding: 1px;
        background-color: rgb(180, 0, 170);
        border-radius: 4px;
    }
    
    .textLayer .highlight.begin {
        border-radius: 4px 0px 0px 4px;
    }
    
    .textLayer .highlight.end {
        border-radius: 0px 4px 4px 0px;
    }
    
    .textLayer .highlight.middle {
        border-radius: 0px;
    }
    
    .textLayer .highlight.selected {
        background-color: rgb(0, 100, 0);
    }
    
    .textLayer ::selection { 
        background: rgba(0, 0, 255, 0.3); 
    }
    
    /* Loading Styles */
    .pdf-loading {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin: 40px auto;
        max-width: 400px;
        z-index: 10;
    }
    
    .progress {
        width: 100%;
        margin-top: 15px;
    }
    
    .loading-text {
        margin-top: 15px;
        font-weight: 500;
    }
    
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #dc3545;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #pdf-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f1f1f1;
        border-bottom: 1px solid #ddd;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .zoom-controls {
        display: flex;
        align-items: center;
    }
    
    #zoom-level {
        display: inline-block;
        min-width: 60px;
        text-align: center;
        font-weight: 500;
    }
    
    /* Make PDF container transition smoothly during zoom */
    .pdf-page-container {
        transition: transform 0.2s ease;
    }
    
    /* Fullscreen mode styles */
    .fullscreen-active {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        margin: 0 !important;
        padding: 0 !important;
        background-color: #525659 !important;
    }
    
    .fullscreen-active #pdf-toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        background-color: rgba(241, 241, 241, 0.95);
    }
    
    .fullscreen-active #pdf-viewer {
        height: calc(100vh - 50px) !important;
        padding-top: 50px !important;
    }
    
    /* Add a nice transition effect when entering/exiting fullscreen */
    #pdf-container, #pdf-viewer {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('courses.index') }}" class="text-decoration-none text-danger">Courses</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}" class="text-decoration-none text-danger">{{ course.title }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('chapters.view', chapter_id=chapter.id) }}" class="text-decoration-none text-danger">{{ chapter.title }}</a></li>
            <li class="breadcrumb-item active">{{ document.title }}</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block heading %}{{ document.title }}{% endblock %}

{% block content %}
<!-- Document meta section and preview remain the same -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="document-meta d-flex justify-content-between align-items-center">
            <div>
                <span class="file-type-badge 
                    {% if document.file_type == 'pdf' %}pdf-badge
                    {% elif document.file_type in ['doc', 'docx'] %}doc-badge
                    {% elif document.file_type in ['ppt', 'pptx'] %}ppt-badge
                    {% endif %}">
                    {{ document.file_type.upper() }}
                </span>
                <span class="ms-2 text-muted">Uploaded on {{ document.created_at.strftime('%b %d, %Y') }}</span>
            </div>
            <div>
                <a href="{{ url_for('ai.chat', document_id=document.id) }}" class="btn btn-danger">
                    <i class="fas fa-robot me-2"></i>Ask AI about this document
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Document actions remain the same -->
<div class="document-actions text-center">
    <a href="{{ url_for('ai.chat', document_id=document.id) }}" class="btn btn-outline-danger me-2">
        <i class="fas fa-robot me-2"></i>Ask AI
    </a>
    <a href="{{ url_for('chapters.serve_uploads', filename=document.file_path.replace('\\', '/')) }}" download class="btn btn-outline-danger me-2">
        <i class="fas fa-download me-2"></i>Download Document
    </a>
    {% if not current_user.is_teacher %}
    <a href="{{ url_for('quiz.setup', document_id=document.id) }}" class="btn btn-danger">
        <i class="fas fa-question-circle me-2"></i>Take Quiz
    </a>
    {% endif %}
</div>

<!-- Document summary section remains the same -->
{% if document.summary %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="summary-section">
            <div class="d-flex justify-content-between align-items-center" id="summaryHeader">
                <h4><i class="fas fa-lightbulb me-2 text-warning"></i>Document Summary</h4>
                <button class="btn btn-sm btn-outline-secondary" id="toggleSummary">
                    <i class="fas fa-chevron-up" id="summaryIcon"></i>
                </button>
            </div>
            <div id="summaryContent" class="mt-3 markdown-content">
                {{ document.summary|markdown }}
            </div>
        </div>
    </div>
</div>

<style>
    #summaryHeader {
        cursor: pointer;
    }
    .summary-section {
        transition: all 0.3s ease;
    }
    .summary-collapsed {
        padding-bottom: 0.5rem !important;
    }
    /* Markdown content styling */
    .markdown-content {
        line-height: 1.5;
    }
    .markdown-content h1, 
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    .markdown-content strong {
        font-weight: 600;
    }
    .markdown-content ul, 
    .markdown-content ol {
        padding-left: 1.5rem;
        margin-bottom: 1rem;
    }
    .markdown-content p {
        margin-bottom: 0.75rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggleSummary');
        const summaryHeader = document.getElementById('summaryHeader');
        const summaryContent = document.getElementById('summaryContent');
        const summaryIcon = document.getElementById('summaryIcon');
        const summarySection = document.querySelector('.summary-section');
        
        // Toggle function for summary
        function toggleSummary() {
            if (summaryContent.style.display === 'none') {
                summaryContent.style.display = 'block';
                summaryIcon.classList.remove('fa-chevron-down');
                summaryIcon.classList.add('fa-chevron-up');
                summarySection.classList.remove('summary-collapsed');
            } else {
                summaryContent.style.display = 'none';
                summaryIcon.classList.remove('fa-chevron-up');
                summaryIcon.classList.add('fa-chevron-down');
                summarySection.classList.add('summary-collapsed');
            }
        }
        
        // Click handlers for both the button and the header
        toggleBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering the header click
            toggleSummary();
        });
        
        summaryHeader.addEventListener('click', function() {
            toggleSummary();
        });
    });
</script>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-alt me-2"></i>Document Preview
            </div>
            <div class="card-body p-0">
                <div class="document-preview" id="documentPreview">
                    {% if document.file_type == 'pdf' %}
                    <div id="pdf-container">
                        <div id="pdf-toolbar">
                            <div>
                                <strong>PDF Viewer</strong>
                            </div>
                            <div class="zoom-controls">
                                <button id="zoom-out" class="btn btn-sm btn-outline-secondary" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <span id="zoom-level" class="mx-2">100%</span>
                                <button id="zoom-in" class="btn btn-sm btn-outline-secondary" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button id="zoom-reset" class="btn btn-sm btn-outline-secondary ms-2" title="Reset Zoom">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button id="fullscreen-toggle" class="btn btn-sm btn-outline-secondary ms-3" title="Toggle Fullscreen">
                                    <i class="fas fa-expand" id="fullscreen-icon"></i>
                                </button>
                            </div>
                            <div id="page-info">
                                Total pages: <span id="total-pages">0</span>
                            </div>
                        </div>
                        <div id="pdf-viewer">
                            <div class="pdf-loading">
                                <div class="spinner"></div>
                                <div id="loading-status">Loading PDF...</div>
                                <div class="progress mt-2 w-100">
                                    <div id="loading-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="pdf-pages-container">
                                <!-- PDF pages will be dynamically added here -->
                            </div>
                        </div>
                        <div id="pdf-controls" style="display: none;">
                            <!-- Controls hidden in continuous mode -->
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <h5>Document Preview</h5>
                        <p class="text-muted">Preview not available for this file type. Please download the document to view its contents.</p>
                        
                        {% if document.file_type in ['doc', 'docx'] %}
                        <i class="fas fa-file-word fa-4x text-primary mb-3"></i>
                        {% elif document.file_type in ['ppt', 'pptx'] %}
                        <i class="fas fa-file-powerpoint fa-4x text-warning mb-3"></i>
                        {% else %}
                        <i class="fas fa-file fa-4x text-secondary mb-3"></i>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="document-actions text-center">
                    <a href="{{ url_for('chapters.serve_uploads', filename=document.file_path.replace('\\', '/')) }}" download class="btn btn-outline-danger">
                        <i class="fas fa-download me-2"></i>Download Document
                    </a>
                    
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_teacher and course.teacher_id == current_user.id %}
<div class="row mt-4">
    <div class="col-md-12 text-end">
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteDocumentModal">
            <i class="fas fa-trash me-2"></i>Delete Document
        </button>
    </div>
</div>

<!-- Delete Document Modal -->
<div class="modal fade" id="deleteDocumentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the document "{{ document.title }}"?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('chapters.delete_document', document_id=document.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Notes section with scrollable content and fixed delete functionality -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-sticky-note me-2"></i>My Notes
                </div>
                <button class="btn btn-sm btn-outline-danger" id="toggleNotes">
                    <i class="fas fa-chevron-up" id="notesIcon"></i>
                </button>
            </div>
            <div class="card-body" id="notesContent">
                <!-- Add Note Form - Moved to the top -->
                <form id="addNoteForm" action="{{ url_for('notes.add_note') }}" method="POST" enctype="multipart/form-data" class="mb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="document_id" value="{{ document.id }}">
                    
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">Add a note</label>
                        <textarea class="form-control" id="noteContent" name="content" rows="3" placeholder="Type your notes here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="noteImage" class="form-label">Or upload an image</label>
                        <input class="form-control" type="file" id="noteImage" name="image" accept="image/*">
                        <small class="text-muted">Supported formats: JPG, PNG, GIF</small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" id="submitNoteBtn" class="btn btn-danger">
                            <i class="fas fa-plus me-2"></i>Add Note
                        </button>
                    </div>
                </form>
                
                <!-- Existing Notes with scrollable container -->
                <div id="existingNotes" class="mb-4">
                    {% if notes %}
                        {% for note in notes %}
                            <div class="note-item mb-3 p-3 border rounded" id="note-{{ note.id }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <small class="text-muted">{{ note.created_at.strftime('%b %d, %Y, %I:%M %p') }}</small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger note-delete-btn" data-note-id="{{ note.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                {% if note.content %}
                                    <div class="note-text">{{ note.content }}</div>
                                {% endif %}
                                
                                {% if note.image_path %}
                                    <div class="note-image mt-2">
                                        <img src="{{ url_for('notes.serve_note_image', filename=note.image_path) }}" 
                                             class="img-fluid rounded" alt="Note image">
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4" id="no-notes-message">
                            <i class="fas fa-sticky-note fa-2x mb-2"></i>
                            <p>You haven't added any notes yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styling for notes -->
<style>
    .note-item {
        background-color: #fff;
        transition: all 0.2s ease;
    }
    
    .note-item:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    #toggleNotes, #notesHeader {
        cursor: pointer;
    }
    
    @media (max-width: 576px) {
        .note-item {
            padding: 0.75rem !important;
        }
    }
</style>

<!-- Scripts for notes functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle notes visibility
    const toggleBtn = document.getElementById('toggleNotes');
    const notesContent = document.getElementById('notesContent');
    const notesIcon = document.getElementById('notesIcon');
    
    // Initialize toggle state (show by default)
    let notesVisible = true;
    
    // Function to toggle notes visibility
    function toggleNotesVisibility() {
        if (!notesVisible) {
            notesContent.style.display = 'block';
            notesIcon.classList.remove('fa-chevron-down');
            notesIcon.classList.add('fa-chevron-up');
            notesVisible = true;
        } else {
            notesContent.style.display = 'none';
            notesIcon.classList.remove('fa-chevron-up');
            notesIcon.classList.add('fa-chevron-down');
            notesVisible = false;
        }
    }
    
    // Add click event listener to the toggle button
    toggleBtn.addEventListener('click', function() {
        toggleNotesVisibility();
    });
    
    // Delete note functionality
    const setupDeleteButtons = () => {
        const deleteButtons = document.querySelectorAll('.note-delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (confirm('Are you sure you want to delete this note?')) {
                    const noteId = this.getAttribute('data-note-id');
                    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                    
                    // Fix: Use proper URL with string interpolation
                    fetch(`/notes/delete_note/${noteId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            // Remove the note from DOM
                            const noteElement = document.getElementById(`note-${noteId}`);
                            if (noteElement) {
                                noteElement.remove();
                            }
                            
                            // Check if there are no notes left
                            const remainingNotes = document.querySelectorAll('.note-item');
                            if (remainingNotes.length === 0) {
                                // Show "no notes" message
                                const noNotesDiv = document.createElement('div');
                                noNotesDiv.id = 'no-notes-message';
                                noNotesDiv.className = 'text-center text-muted py-4';
                                noNotesDiv.innerHTML = `
                                    <i class="fas fa-sticky-note fa-2x mb-2"></i>
                                    <p>You haven't added any notes yet.</p>
                                `;
                                document.getElementById('existingNotes').appendChild(noNotesDiv);
                            }
                        } else {
                            alert('Failed to delete the note. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the note.');
                    });
                }
            });
        });
    };
    
    // Run once on page load
    setupDeleteButtons();
    
    // Submit note form
    const noteForm = document.getElementById('addNoteForm');
    const submitBtn = document.getElementById('submitNoteBtn');
    
    submitBtn.addEventListener('click', function() {
        // Show loading state
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        submitBtn.disabled = true;
        
        const formData = new FormData(noteForm);
        
        // Submit form using fetch API
        fetch(noteForm.action, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove "no notes" message if it exists
                const noNotesMsg = document.getElementById('no-notes-message');
                if (noNotesMsg) {
                    noNotesMsg.remove();
                }
                
                // Add the new note to the top of the list
                const noteHtml = `
                    <div class="note-item mb-3 p-3 border rounded" id="note-${data.note.id}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">${data.note.created_at}</small>
                            <div>
                                <button class="btn btn-sm btn-outline-danger note-delete-btn" data-note-id="${data.note.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${data.note.content ? `<div class="note-text">${data.note.content}</div>` : ''}
                        
                        ${data.note.image_path ? `
                            <div class="note-image mt-2">
                                <img src="${data.note.image_url || '/notes/note_image/' + data.note.image_path}" 
                                     class="img-fluid rounded" alt="Note image">
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('existingNotes').insertAdjacentHTML('afterbegin', noteHtml);
                
                // Reset form
                noteForm.reset();
                
                // Setup delete buttons again to include the new one
                setupDeleteButtons();
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Your note has been added.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                noteForm.insertAdjacentElement('beforebegin', alertDiv);
                
                // Auto-dismiss the alert after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
                
            } else {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Error!</strong> ${data.message || 'Failed to add your note. Please try again.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                noteForm.insertAdjacentElement('beforebegin', alertDiv);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <strong>Error!</strong> An error occurred while adding your note.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            noteForm.insertAdjacentElement('beforebegin', alertDiv);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        });
    });
    
    // Preview uploaded image before submission (optional enhancement)
    const imageInput = document.getElementById('noteImage');
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            console.log(`Image selected: ${file.name}`);
        }
    });
});
</script>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if document.file_type == 'pdf' %}
        // Load PDF.js library
        const pdfJsScript = document.createElement('script');
        pdfJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js';
        pdfJsScript.async = true;
        
        pdfJsScript.onload = function() {
            // Set the worker source
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            initPdfViewer();
        };
        
        pdfJsScript.onerror = function() {
            document.getElementById('pdf-viewer').innerHTML = '<div class="text-center py-5"><p class="text-danger">Failed to load PDF viewer. Please try downloading the document instead.</p></div>';
        };
        
        document.body.appendChild(pdfJsScript);
        {% endif %}
    });
    
    {% if document.file_type == 'pdf' %}
    function initPdfViewer() {
        // Variables
        let pdfDoc = null;
        // Initial scale (100%)
        let scale = 1.0;
        let currentPageRendering = [];
        let pagesRendered = 0;
        let isFullscreen = false;
        
        // Get container reference
        const container = document.getElementById('pdf-pages-container');
        const pdfContainer = document.getElementById('pdf-container');
        const pdfViewer = document.getElementById('pdf-viewer');
        
        // Get zoom control elements
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');
        const zoomLevelEl = document.getElementById('zoom-level');
        const fullscreenBtn = document.getElementById('fullscreen-toggle');
        const fullscreenIcon = document.getElementById('fullscreen-icon');
        
        // Hide loading spinner when ready
        document.querySelector('.pdf-loading').style.display = 'none';
        
        // Get the PDF file path with correct URL from the chapters blueprint
        const pdfUrl = "{{ url_for('chapters.serve_uploads', filename=document.file_path.replace('\\', '/')) }}";
        console.log("Loading PDF from:", pdfUrl);
        
        // Create a canvas and text layer for a page
        function createPageCanvas(pageNumber) {
            const pageContainer = document.createElement('div');
            pageContainer.className = 'pdf-page-container';
            pageContainer.dataset.pageNumber = pageNumber;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas';
            canvas.id = `pdf-page-canvas-${pageNumber}`;
            
            pageContainer.appendChild(canvas);
            container.appendChild(pageContainer);
            
            return { pageContainer, canvas };
        }
        function createTextLayer(pageNumber, page, viewport, textContent, pageContainer) {
            // Create text layer div
            const textLayer = document.createElement('div');
            textLayer.className = 'textLayer';
            textLayer.style.width = `${viewport.width}px`;
            textLayer.style.height = `${viewport.height}px`;
            textLayer.style.position = 'absolute';
            textLayer.style.top = '0';
            textLayer.style.left = '0';
            textLayer.style.pointerEvents = 'none'; // Don't block canvas events
            
            pageContainer.appendChild(textLayer);
            
            // Render text layer
            return pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayer,
                viewport: viewport,
                textDivs: []
            }).promise.then(() => {
                // Make text selectable
                textLayer.style.pointerEvents = 'auto';
            });
        }
        
        // Render a page
        function renderPage(pageNumber) {
            pdfDoc.getPage(pageNumber).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                
                // Create canvas for this page
                const { pageContainer, canvas } = createPageCanvas(pageNumber);
                const ctx = canvas.getContext('2d');
                
                // Set dimensions
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                pageContainer.style.width = `${viewport.width}px`;
                pageContainer.style.height = `${viewport.height}px`;
                pageContainer.style.position = 'relative';
                pageContainer.style.marginBottom = '20px'; // Add space between pages
                pageContainer.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
                pageContainer.style.backgroundColor = 'white';
                
                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                // Get text content for text layer
                const textContentPromise = page.getTextContent();
                
                // Track which pages are currently rendering
                currentPageRendering.push(pageNumber);
                
                // Wait for rendering to finish
                Promise.all([renderTask.promise, textContentPromise]).then(function([_, textContent]) {
                    // Create text layer for selection/copy
                    return createTextLayer(pageNumber, page, viewport, textContent, pageContainer);
                }).then(function() {
                    // Remove from currently rendering
                    const index = currentPageRendering.indexOf(pageNumber);
                    if (index !== -1) currentPageRendering.splice(index, 1);
                    
                    // Increment rendered page count
                    pagesRendered++;
                    
                    // Update loading status
                    updateLoadingStatus(pagesRendered, pdfDoc.numPages);
                    
                    // Check if all pages are rendered
                    if (pagesRendered === pdfDoc.numPages) {
                        console.log('All pages rendered successfully');
                        document.getElementById('pdf-controls').style.display = 'none'; // Hide controls
                    }
                });
            }).catch(function(error) {
                console.error(`Error rendering page ${pageNumber}:`, error);
            });
        }
        
        // Zoom functionality
        function changeZoom(newScale) {
            // Store old scale to calculate relative change
            const oldScale = scale;
            
            // Set new scale
            scale = newScale;
            
            // Limit scale between 0.5 and 3.0
            if (scale < 0.5) scale = 0.5;
            if (scale > 3.0) scale = 3.0;
            
            // Update zoom level display
            zoomLevelEl.textContent = `${Math.round(scale * 100)}%`;
            
            // Calculate zoom ratio for transformation
            const zoomRatio = scale / oldScale;
            
            // Clear container to re-render all pages with new scale
            container.innerHTML = '';
            
            // Reset page count for loading indicator
            pagesRendered = 0;
            
            // Show loading indicator again
            document.querySelector('.pdf-loading').style.display = 'flex';
            
            // Render all pages with new scale
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                renderPage(pageNum);
            }
        }
        
        // Toggle fullscreen mode
        function toggleFullscreen() {
            if (isFullscreen) {
                // Exit fullscreen
                pdfContainer.classList.remove('fullscreen-active');
                fullscreenIcon.classList.remove('fa-compress');
                fullscreenIcon.classList.add('fa-expand');
                
                // Reset body scrolling
                document.body.style.overflow = 'auto';
                
                // Scroll to the container's position
                setTimeout(() => {
                    // Scroll back to viewer after exiting fullscreen
                    window.scrollTo({
                        top: pdfContainer.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }, 100);
            } else {
                // Enter fullscreen
                pdfContainer.classList.add('fullscreen-active');
                fullscreenIcon.classList.remove('fa-expand');
                fullscreenIcon.classList.add('fa-compress');
                
                // Prevent body scrolling
                document.body.style.overflow = 'hidden';
                
                // Scroll to top of container
                pdfViewer.scrollTop = 0;
            }
            
            isFullscreen = !isFullscreen;
            
            // Notify screen readers
            const status = isFullscreen ? 'expanded to fullscreen' : 'exited fullscreen';
            const notification = document.createElement('div');
            notification.setAttribute('aria-live', 'polite');
            notification.textContent = `PDF viewer ${status}`;
            notification.style.position = 'absolute';
            notification.style.left = '-9999px';
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 1000);
        }
        
        // Fullscreen event handler
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        
        // Allow ESC key to exit fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        });
        
        // Zoom event handlers
        zoomInBtn.addEventListener('click', function() {
            changeZoom(scale + 0.25);
        });
        
        zoomOutBtn.addEventListener('click', function() {
            changeZoom(scale - 0.25);
        });
        
        zoomResetBtn.addEventListener('click', function() {
            changeZoom(1.0);
        });
        
        // Mouse wheel zoom (with Ctrl key pressed)
        container.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault(); // Prevent page scrolling
                
                if (e.deltaY < 0) {
                    changeZoom(scale + 0.1);
                } else {
                    changeZoom(scale - 0.1);
                }
            }
        });
        
        // Update loading status
        function updateLoadingStatus(current, total) {
            const loadingText = document.getElementById('loading-status');
            if (loadingText) {
                loadingText.textContent = `Loading PDF: ${current} of ${total} pages`;
                
                // Update progress percentage
                const percent = Math.round((current / total) * 100);
                document.getElementById('loading-progress').style.width = `${percent}%`;
                document.getElementById('loading-progress').setAttribute('aria-valuenow', percent);
                
                // Hide loading when complete
                if (current === total) {
                    setTimeout(() => {
                        document.querySelector('.pdf-loading').style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // Load the PDF with additional options to handle potential errors
        pdfjsLib.getDocument({
            url: pdfUrl,
            withCredentials: true,
            cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/',
            cMapPacked: true
        }).promise.then(function(pdf) {
            pdfDoc = pdf;
            document.getElementById('total-pages').textContent = pdf.numPages;
            
            // Show loading progress
            updateLoadingStatus(0, pdf.numPages);
            
            // Render all pages in sequence
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                renderPage(pageNum);
            }
            
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            // More detailed error handling
            document.getElementById('pdf-viewer').innerHTML = `
                <div class="text-center py-5">
                    <p class="text-danger">Failed to load PDF: ${error.message}</p>
                    <p>This might be due to file access restrictions or file not found.</p>
                    <p class="mt-3">Please try downloading the document instead:</p>
                    <a href="{{ url_for('chapters.serve_uploads', filename=document.file_path.replace('\\', '/')) }}" 
                       download class="btn btn-danger mt-2">
                        <i class="fas fa-download me-2"></i>Download PDF
                    </a>
                </div>
            `;
        });
    }
    {% endif %}
</script>
{% endblock scripts %}

{% endblock content %}